<!DOCTYPE html>  
    <html>
    <head>
        <meta charset="utf-8" />
        <title>Gamedev Phaser Workshop - lesson 01: Initialize the framework</title>
        <style>* { padding: 0; margin: 0; }</style>
        <script src="js/phaser.min.js"></script>
        
    </head>
    <body>
    <script>
        var game = new Phaser.Game(600, 400, Phaser.AUTO, null, {preload: preload, create: create, update: update});

        var ball;
        var paddle;
        var bricks;
        var elfBricks;
        var newBrick;
        var brickInfo;
        var score1Text;
        var score2Text;
        var cursors;
        var score1 = 0;
        var score2 = 0;
        var lives1 = 3;
        var lives2 = 3;
        var lives1Text;
        var lives2Text;
        var life1LostText;
        var life2LostText;
        var playing = false;
        var startButton;
        var count1 = 0;
        var count2 = 0;
        var obstacle;

        function preload() {
            //handleRemoteImagesOnJSFiddle();

            game.scale.scaleMode = Phaser.ScaleManager.SHOW_ALL;
            game.scale.pageAlignHorizontally = true;
            game.scale.pageAlignVertically = true;
            game.load.crossOrigin = 'anonymous';
            game.stage.backgroundColor = '#eee';
            game.load.image('paddle', 'https://limmm.com/PhaseGames/img/paddle.png');
            game.load.image('brick', 'https://limmm.com/PhaseGames/img/brick.png');
            game.load.spritesheet('obstacle','https://limmm.com/PhaseGames/img/3.png', 59, 55);
            game.load.spritesheet('ball', 'https://limmm.com/PhaseGames/img/wobble.png', 20, 20);
            game.load.spritesheet('button', 'https://limmm.com/PhaseGames/img/1.png', 120, 40);
            game.load.spritesheet('elf', 'https://limmm.com/PhaseGames/img/elf.png', 32, 48);

        }
        function create() {
            game.physics.startSystem(Phaser.Physics.NINJA);
            game.physics.startSystem(Phaser.Physics.ARCADE);
            //game.physics.ninja.gravity = 0;
            game.physics.ninja.setBoundsToWorld();            
            game.physics.arcade.checkCollision.down = false;
            ball = game.add.sprite(game.world.width*0.5, game.world.height-35, 'ball');

            ball.animations.add('wobble', [0,1,0,2,0,1,0,2,0], 24);
            ball.anchor.set(0.5);
            game.physics.enable(ball, Phaser.Physics.ARCADE);
            ball.body.collideWorldBounds = true;
            ball.body.bounce.set(1);
            ball.checkWorldBounds = true;
            ball.events.onOutOfBounds.add(ballLeaveScreen, this);

            paddle = game.add.sprite(game.world.width*0.5, game.world.height-20, 'paddle');
            paddle.anchor.set(0.5,1);
            game.physics.enable(paddle, Phaser.Physics.ARCADE);
            paddle.body.immovable = true;   
                    
            elf = game.add.sprite(game.world.width*0.2, game.world.height-50, 'elf');
            game.physics.ninja.enable(elf);
            elf.body.bounce = 0.5;
            elf.body.friction= 0.5;
            elf.body.collideWorldBounds = true;
            elf.animations.add('left', [0, 1, 2, 3], 1, true);
            elf.animations.add('right', [5, 6, 7, 8], 1, true);
            elf.animations.add('up', [0, 1, 2, 3], 1, true);
            elf.animations.add('down', [5, 6, 7, 8], 1, true);
            elf.body.gravityScale = 0;
            cursors = game.input.keyboard.createCursorKeys();
            obstacle = game.add.sprite(game.world.width*0.44, game.world.height*0.4, 'obstacle');
            game.physics.ninja.enable(obstacle);
            obstacle.anchor.set(0.5);
            obstacle.body.immovable = true;  
            obstacle.visible = false;
            obstacle.body.gravityScale = 0;


            initBricks();

            textStyle = { font: '12px Arial', fill: '#626262' };
            score1Text = game.add.text(10, 5, 'Master Hams: '+count1, textStyle);
            lives1Text = game.add.text(game.world.width-90, 5, 'Master Lives: '+lives1, textStyle);
            lives1Text.anchor.set(1,0);
            life1LostText = game.add.text(game.world.width*0.5, game.world.height*0.6, 'Master Life lost, tap to continue', textStyle);
            life1LostText.anchor.set(0.5);
            life1LostText.visible = false;
            score2Text = game.add.text(110, 5, 'Elf Hams: '+count2, textStyle);
            lives2Text = game.add.text(game.world.width-10, 5, 'Elf Lives: '+lives2, textStyle);
            lives2Text.anchor.set(1,0);
            life2LostText = game.add.text(game.world.width*0.5, game.world.height*0.5, 'Elf life lost, tap to continue', textStyle);
            life2LostText.anchor.set(0.5);
            life2LostText.visible = false;

            startButton = game.add.button(game.world.width*0.5, game.world.height*0.5, 'button', startGame, this, 1, 0, 2);
            startButton.anchor.set(0.5);
              

        }
        function update() {
            
            if (cursors.left.isDown)
            {
                elf.body.moveLeft(150);
                elf.animations.play('left');
            }
            else if (cursors.right.isDown)
            {
                elf.body.moveRight(150);
                elf.animations.play('right');
            }

            if (cursors.up.isDown)
            {
                elf.body.moveUp(150);
                elf.animations.play('up');
            }
            else if (cursors.down.isDown)
            {
                elf.body.moveDown(50);
                elf.animations.play('down');
            }

            if(playing) {
                game.physics.arcade.collide(ball, paddle, ballHitPaddle);
            game.physics.arcade.collide(ball, bricks, ballHitBrick);
            game.physics.ninja.collide(elf, elfBricks, elfHitBricks);
            game.physics.ninja.collide(elf, obstacle, elfHitObs);
                paddle.x = game.input.x || game.world.width*0.5;
                
            }
            
            
        }
        function initBricks() {
            headcount = 
            brickInfo = {
                width: 50,
                height: 20,
                count: {
                    row: Math.random() * 11,
                    col: Math.random() * 7
                },
                offset: {
                    top: 50,
                    left: 60
                },
                padding: 20
            }
            elfBricks = game.add.group();
            bricks = game.add.group();
            
            for(c=0; c<brickInfo.count.col; c++) {
                for(r=0; r<brickInfo.count.row; r++) {
                    var brickX = (r*(brickInfo.width+brickInfo.padding))+brickInfo.offset.left;
                    var brickY = (c*(brickInfo.height+brickInfo.padding))+brickInfo.offset.top;
                    newBrick = game.add.sprite(brickX, brickY, 'brick');
                    if((count1 + count2)%3 === 0){
                        game.physics.enable(newBrick, Phaser.Physics.ARCADE);
                        newBrick.anchor.set(0.5);
                        newBrick.body.immovable = true;                  
                        bricks.add(newBrick);
                        count1++;
                    }
                    else{
                        game.physics.enable(newBrick, Phaser.Physics.NINJA);
                        newBrick.anchor.set(0.5);
                        newBrick.body.immovable = true;
                        newBrick.body.gravityScale = 0;
                        elfBricks.add(newBrick);
                        count2++;
                    }
                    
                    
                    
                }
            }
        }
        function ballHitBrick(ball, brick) {
            var killTween = game.add.tween(brick.scale);
            killTween.to({x:0,y:0}, 200, Phaser.Easing.Linear.None);
            killTween.onComplete.addOnce(function(){
                brick.kill();
            }, this);
            killTween.start();
            score1 += 10;
            score1Text.setText('Master Points: '+score1);
            if(score1 === count1*10) {
                alert('Streamer won the game, congratulations!');
                location.reload();
            }
        }

        function ballLeaveScreen() {
            lives1--;
            if(lives1) {
                lives1Text.setText('Master Lives: '+lives1);
                life1LostText.visible = true;
                ball.reset(game.world.width*0.4, game.world.height-69);
                paddle.reset(game.world.width*0.4, game.world.height-50);
                game.input.onDown.addOnce(function(){
                    life1LostText.visible = false;
                    ball.body.velocity.set(150, -150);
                }, this);
            }
            else {
                alert('Elf won!');
                location.reload();
            }
        }
        function ballHitPaddle(ball, paddle) {
            ball.animations.play('wobble');
            ball.body.velocity.x = -1*5*(paddle.x-ball.x);
        }
        function elfHitObs(elf, obstacle){
            lives2--;
            if(lives2) {
                    lives2Text.setText('Master Lives: '+lives2);
                    life2LostText.visible = true;
                    elf.reset(game.world.width*0.2, game.world.height-50);
                    life2LostText.visible = false;  
                    elf.body.gravityScale += 2;               
                }
                else {
                    alert('Master win!');
                    location.reload();
                }
            

        }
        function elfHitBricks(elf, brick){
            
            var killTween = game.add.tween(brick.scale);
            killTween.to({x:0,y:0}, 5, Phaser.Easing.Linear.None);
            killTween.onComplete.addOnce(function(){
                brick.kill();
                
            }, this);
            killTween.start();
            score2 += 10;
            score2Text.setText('Elf Points: '+score2);
            if(score2 === count2*10) {
                alert('Elf won the game, congratulations!');
                location.reload();
            }        
        }
        function startGame() {
            startButton.destroy();
            ball.body.velocity.set(150, -150);
            obstacle.visible = true;
            playing = true;
        }

        // 
        function handleRemoteImagesOnJSFiddle() {
            game.load.baseURL = 'https://rubyfrea.github.io/PhaseGames';
            game.load.crossOrigin = 'anonymous';
        }
    </script>
    </body>
    </html>